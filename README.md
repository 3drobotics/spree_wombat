# Spree Wombat

Connect your SpreeCommerce Storefront to Wombat, providing push API and webhook handlers

## Installation

Add spree_wombat to your Gemfile:

```ruby
gem 'spree_wombat', github: 'spree/spree_wombat', branch: '2-2-stable'
```

Bundle your dependencies and run the installation generator:

```shell
bundle
bundle exec rails g spree_wombat:install
```

Add your Wombat credentials to `config/initializers/wombat.rb`:

```ruby
Spree::Wombat::Config.configure do |config|
  config.connection_token = "YOUR TOKEN"
  config.connection_id = "YOUR CONNECTION ID"
end
```

## Configuration

All the configuration is done inside the initializer here: `config/initializers/wombat.rb`

### push_url

You can override the default url to push your data to.

```ruby
config.push_url = "http://mycustomurl"
```

### push_objects

The push_objects is an array of model names that are selected to push to Wombat.

```ruby
config.push_objects = ["Spree::Order", "Spree::Product"]
```

### payload_builder

To push the data to Wombat we need to configure the way we construct the JSON payload.


```ruby
config.payload_builder = {
  "Spree::Order"  => {:serializer => "Spree::Wombat::OrderSerializer", :root => "orders"},
  "Spree::Product" => {:serializer => "Spree::Wombat::ProductSerializer", :root => "products"},
}

```
The payload builder is a hash, the key is the model name we also use in the `push_objects` config.

Each model has a `serializer` and a `root` field that defines the serializer we use to serialize to JSON and the root defines the root node for that JSON.

### last_pushed_timestamps

For every model we push to Wombat we keep track when we pushed the objects

## Push to the hub

```shell
bundle exec rake wombat:push_it
```

## Create handler for a webhook

```shell
bundle exec rails g wombat:webhook my_webhook
```

this will generate a handler class for the `my_webhook` webhook in `lib/spree/wombat/handler/my_webhookhandler.rb`

```ruby
module Spree
  module Wombat
    module Handler
      class MyWebhookHandler < Base

        def process
          @webhook = @payload[:webhook]

          #insert code here to handle
        end

      end
    end
  end
end

```


## Create custom serializers

```shell
bundle exec rails g wombat:serializer
```


## Testing

First bundle your dependencies, then run `rake`. `rake` will default to building the dummy app if it does not exist, then it will run specs. The dummy app can be regenerated by using `rake test_app`.

```shell
bundle
bundle exec rake
```

Copyright (c) 2014 Spree Commerce, Inc. and other contributors, released under the New BSD License
